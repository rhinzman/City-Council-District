<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Detroit City Council District Map</title>

  <!-- ArcGIS API CSS and JavaScript -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.25/"></script>

  <!-- Custom styles for full-screen map and button -->
  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

  #council-filter {
    background-color: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  }
    
  </style>
  
  <!-- ArcGIS map configuration and widgets with expandable containers and home button -->
  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Search",
      "esri/widgets/Home",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      
      
    ], function (esriConfig, Map, MapView, BasemapGallery, Search, Home, FeatureLayer, Legend, Expand) {
      esriConfig.apiKey = "AAPK9010d0b61469421388268a0a3d6b9970behQAuDdJqQ1pqWiFduaupUbAQXKrMzBGDNlYvnzFhJVmo4o4_JV_Y0cDx9Umj8M";

      const map = new Map({
        basemap: "dark-gray"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-83.046, 42.34],
        zoom: 11
      });

      const basemapGallery = new BasemapGallery({
        view: view
      });
      const expandBasemap = new Expand({
        view: view,
        content: basemapGallery,
        expandIconClass: "esri-icon-basemap",
        expanded: false
      });

      view.ui.add(expandBasemap, "top-left");

      const home = new Home({
        view: view
      });
      view.ui.add(home, "top-left");

      

    // Add FeatureLayer for the AGOL table
    const trackerTable = new FeatureLayer({
      url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/searchQueries/FeatureServer/0"
    });


      const search = new Search({
        view: view
      });

      
      const expandSearch = new Expand({
        view: view,
        content: search,
        expandIconClass: "esri-icon-search",
        expanded: true
      });
      

      //old listerner

      // search.on("select-result", function(event){
      //   console.log(event.result);
      // });

      //new listener

      search.on("select-result", function(event) {
        console.log(event.result);
      const result = event.result;
      const address = result.name; // assuming 'name' contains the address
      const longitude = result.feature.geometry.longitude;
      const latitude = result.feature.geometry.latitude;

      // Prepare the attributes for the new record
      const attributes = {
        Address: address,
        Lon: longitude,
        Lat: latitude
      };

      // Create a new feature to add to the table
      const newRecord = {
        attributes: attributes
      };

      // Use applyEdits to add the new record
      trackerTable.applyEdits({
        addFeatures: [newRecord]
      }).then(function(response) {
        console.log("Record added:", response.addFeatureResults);
      }).catch(function(error) {
        console.error("Error adding record:", error);
      });
    });

 

      view.ui.add(expandSearch, "top-right");
      
      const councilFilter = new Expand({
        view: view,
        content: document.getElementById("council-filter"),
        expandIconClass: "esri-icon-filter",
        expanded: true
      });
      view.ui.add(councilFilter, "top-right");

      function filterDistrict(district) {
        cityCouncil.definitionExpression = `District_N = ${district}`;
      }


      document.getElementById("district1").addEventListener("click", function() {
        filterDistrict(1);
      });


      const cityCouncil = new FeatureLayer({
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/CityCouncilDistrict/FeatureServer/0",
        outFields: ["District_N"],
        popupTemplate: {
          title: "City Council District {District_N}",
          content: "This is City Council District {District_N}"
        }
      });

      map.add(cityCouncil);

      cityCouncil.renderer = {
        type: "simple",
        symbol: {
          type: "simple-fill",
          color: "rgba(192, 192, 192, .10)",
          outline: {
            color: "white",
            width: 1
          }
        }
      };

      const legend = new Legend({
        view: view,
        layerInfos: [{
          layer: cityCouncil,
          title: "City Council Districts"
        }]
      });
      const expandLegend = new Expand({
        view: view,
        content: legend,
        expandIconClass: "esri-icon-layer-list",
        expanded: true
      });

      view.ui.add(expandLegend, "bottom-right");
    });
  </script>
</head>
<body>
  <div id="viewDiv"></div>
  <div class="'council-filter-item" id="council-filter">
    <div id="titleDiv">
      <h2 id="titleText">Detroit City Council Districts</h2>
    </div>
    <div class="council-filter-item" id="district1">District 1</div>
    <div class="council-filter-item" id="district2">District 2</div>
    <div class="council-filter-item" id="district3">District 3</div>
    <div class="council-filter-item" id="district4">District 4</div>
    <div class="council-filter-item" id="district5">District 5</div>
    <div class="council-filter-item" id="district6">District 6</div>
    <div class="council-filter-item" id="district7">District 7</div>
  </div>

</body>
</html>